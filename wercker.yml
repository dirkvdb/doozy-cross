box: dirkvdb/cxx14arm
no-response-timeout: 10
build:
    steps:
        - script:
            name: Setup environnement variables
            code: |
                SRC_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
                BUILD_DIR="${SRC_DIR}/build"
                UPNP_VER="1.6.19"
                echo "SRC_DIR ${SRC_DIR}"
                echo "BUILD_DIR ${BUILD_DIR}"
                echo "UPNP_VER ${UPNP_VER}"

        - script:
            name: Cross compile dependencies
            code: |
                cd cross
                bash ./buildall.sh

        - script:
            name: Cross Compile doozy
            code: |
                git clone https://github.com/dirkvdb/doozy.git
                cd doozy
                git checkout develop
                git submodule update --init --recursive
                cd ..
                mkdir build
                cd build
                cmake -DCMAKE_TOOLCHAIN_FILE=../cross/toolchain-armv6.make -DCMAKE_BUILD_TYPE=Release ../doozy
                make -j4

deploy:
    steps:
        - add-to-known_hosts:
            hostname: dirkvdb.no-ip.biz
        - mktemp:
            envvar: PRIVATEKEY_PATH
        - create-file:
            name: write key
            filename: $PRIVATEKEY_PATH
            content: $RASPI_PRIVATE
            overwrite: true
            hide-from-log: true
        - script:
            name: transfer application
            code: |
                pwd
                ls -la
                scp -i $PRIVATEKEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=no build/doozy dirk@dirkvdb.no-ip.biz:~/wercker/
